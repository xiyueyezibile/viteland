{"version":3,"sources":["../../../package.json","../index.ts","../createServer.ts","../plugins/pluginIndexHtml.ts","../ssr/build.ts","../ssr/renderPage.ts"],"sourcesContent":["{\n  \"name\": \"viteland\",\n  \"version\": \"1.0.0\",\n  \"description\": \"\",\n  \"main\": \"index.js\",\n  \"scripts\": {\n    \"test\": \"echo \\\"Error: no test specified\\\" && exit 1\"\n  },\n  \"keywords\": [],\n  \"author\": \"\",\n  \"license\": \"ISC\",\n  \"devDependencies\": {\n    \"@types/node\": \"^20.11.26\",\n    \"@typescript-eslint/eslint-plugin\": \"^7.2.0\",\n    \"@typescript-eslint/parser\": \"^7.2.0\",\n    \"babel-eslint\": \"^10.1.0\",\n    \"eslint\": \"^8.57.0\",\n    \"eslint-config-prettier\": \"^9.1.0\",\n    \"eslint-plugin-import\": \"^2.29.1\",\n    \"eslint-plugin-prettier\": \"^5.1.3\",\n    \"eslint-plugin-react\": \"^7.34.0\",\n    \"lerna\": \"^8.1.2\",\n    \"prettier\": \"^3.2.5\",\n    \"typescript\": \"^5.4.2\"\n  }\n}\n","import { cac } from 'cac';\r\nimport path, { resolve } from 'path';\r\nimport { createServer } from './createServer';\r\nimport { build } from './ssr/build';\r\nimport { PACKAGE_ROOT } from '@viteland/utils';\r\n\r\nconst version = require('../../package.json').version;\r\n\r\nconst cli = cac('island').version(version).help();\r\n\r\ncli\r\n  .command('[root]', 'start dev server')\r\n  .alias('dev')\r\n  .action(async (root: string) => {\r\n    // 添加以下逻辑\r\n    const serverRoot = root ? path.resolve(__dirname, '../../../' + root) : process.cwd();\r\n\r\n    try {\r\n      const server = await createServer(serverRoot);\r\n      await server.listen();\r\n      server.printUrls();\r\n    } catch (error) {\r\n      console.log(serverRoot);\r\n      console.log(error);\r\n    }\r\n  });\r\n\r\ncli.command('build [root]', 'build for production').action(async (root: string) => {\r\n  const serverRoot = root ? path.resolve(__dirname, '../../../' + root) : path.join(PACKAGE_ROOT, 'packages/view');\r\n  console.log(serverRoot);\r\n  try {\r\n    await build(serverRoot);\r\n  } catch (e) {\r\n    console.log(serverRoot);\r\n    console.log(e);\r\n  }\r\n});\r\n\r\ncli.parse();\r\n","import { createServer as createViteDevServer } from 'vite';\r\nimport { pluginIndexHtml } from './plugins/pluginIndexHtml';\r\n/**\r\n * @link https://cn.vitejs.dev/guide/api-javascript.html#createserver\r\n */\r\n// 启动开发服务器\r\nexport async function createServer(root = process.cwd()) {\r\n  return createViteDevServer({\r\n    plugins: [pluginIndexHtml()],\r\n    root\r\n  });\r\n}\r\n","import { readFile } from 'fs/promises';\r\nimport { Plugin } from 'vite';\r\nimport { CLIENT_ENTRY_PATH, DEFAULT_HTML_PATH } from '@viteland/utils';\r\n\r\nexport function pluginIndexHtml(): Plugin {\r\n  return {\r\n    name: 'viteland-html',\r\n    apply: 'serve',\r\n    // 插入入口 script 标签\r\n    transformIndexHtml(html) {\r\n      return {\r\n        html,\r\n        tags: [\r\n          {\r\n            tag: 'script',\r\n            attrs: {\r\n              type: 'module',\r\n              // vite约定 @fs 标识后面为一个绝对路径\r\n              src: `/@fs/${CLIENT_ENTRY_PATH}`\r\n            },\r\n            injectTo: 'body'\r\n          }\r\n        ]\r\n      };\r\n    },\r\n    // 开发服务器钩子\r\n    configureServer(server) {\r\n      return () => {\r\n        // 添加中间件\r\n        server.middlewares.use(async (req, res, next) => {\r\n          // 读取模版\r\n          let html = await readFile(DEFAULT_HTML_PATH, 'utf-8');\r\n\r\n          try {\r\n            // 配置热更新\r\n            html = await server.transformIndexHtml(req.url, html, req.originalUrl);\r\n\r\n            res.statusCode = 200;\r\n            res.setHeader('Content-Type', 'text/html');\r\n            res.end(html);\r\n          } catch (e) {\r\n            return next(e);\r\n          }\r\n        });\r\n      };\r\n    }\r\n  };\r\n}\r\n","import { CLIENT_ENTRY_PATH, PACKAGE_ROOT, SERVER_ENTRY_PATH } from '@viteland/utils';\r\nimport pluginReact from '@vitejs/plugin-react';\r\nimport { InlineConfig, build as viteBuild } from 'vite';\r\nimport { renderPage } from './renderPage';\r\nimport { join } from 'path';\r\n/**\r\n * @link https://cn.vitejs.dev/guide/api-javascript.html#build\r\n */\r\nexport async function build(root: string = process.cwd()) {\r\n  const [clientBundle, serverBundle] = await bundle(root);\r\n  const { render } = require(join(PACKAGE_ROOT, 'packages/view/.temp/ssr-entry.cjs'));\r\n  await renderPage(render, root, clientBundle);\r\n}\r\n\r\nexport async function bundle(root: string) {\r\n  const resolveViteConfig = (isServer: boolean): InlineConfig => ({\r\n    mode: 'production',\r\n    root,\r\n    // 自动注入 import React from 'react'，避免 React is not defined 的错误\r\n    plugins: [pluginReact()],\r\n    build: {\r\n      ssr: isServer,\r\n      outDir: isServer ? '.temp' : 'build',\r\n      rollupOptions: {\r\n        input: isServer ? SERVER_ENTRY_PATH : CLIENT_ENTRY_PATH,\r\n        output: {\r\n          format: isServer ? 'cjs' : 'esm'\r\n        }\r\n      }\r\n    }\r\n  });\r\n\r\n  console.log(`Building client + server bundles...`);\r\n\r\n  try {\r\n    // Promise.all 并发\r\n    const [clientBundle, serverBundle] = await Promise.all([\r\n      // client build\r\n      viteBuild(resolveViteConfig(false)),\r\n      // server build\r\n      viteBuild(resolveViteConfig(true))\r\n    ]);\r\n    return [clientBundle, serverBundle];\r\n  } catch (e) {\r\n    console.log(e);\r\n  }\r\n}\r\n","import * as fs from 'fs-extra';\r\nimport { join } from 'path';\r\n\r\nexport async function renderPage(render: () => string, root: string, clientBundle) {\r\n  // 找出所有客户端入口文件chunk\r\n  const clientChunk = clientBundle.output.find((chunk) => chunk.type === 'chunk' && chunk.isEntry);\r\n  console.log(`Rendering page in server side...`);\r\n  // 生产服务端页面\r\n  const appHtml = render();\r\n  const html = `\r\n<!DOCTYPE html>\r\n<html>\r\n  <head>\r\n    <meta charset=\"utf-8\">\r\n    <meta name=\"viewport\" content=\"width=device-width,initial-scale=1\">\r\n    <title>title</title>\r\n    <meta name=\"description\" content=\"xxx\">\r\n  </head>\r\n  <body>\r\n    <div id=\"root\">${appHtml}</div>\r\n    <script type=\"module\" src=\"/${clientChunk?.fileName}\"></script>\r\n  </body>\r\n</html>`.trim();\r\n  // 生成文件夹\r\n  await fs.ensureDir(join(root, 'build'));\r\n  // 注入页面\r\n  await fs.writeFile(join(root, 'build/index.html'), html);\r\n  await fs.remove(join(root, '.temp'));\r\n}\r\n"],"mappings":"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","names":["exports","module","import_path","createViteDevServer","import_utils","import_vite","import_path","pluginReact","viteBuild","import_utils","path"]}